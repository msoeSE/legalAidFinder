language: node_js, java
sudo: required
dist: trusty
env:
  global:
    - COMMIT=${TRAVIS_COMMIT::8}
    - REPO=msoese/legal-aid-finder
node_js:
  - '7'
jdk:
  - 'oraclejdk8'
before_install:
  - export CHROME_BIN=chromium-browser
  - export DISPLAY=:99.0
  - sh -e /etc/init.d/xvfb start
  - nvm install 6.9.5
  - npm install -g yarn
install:
    - yarn install
script:
    - yarn test
before_script:
  #
script:
  - sudo docker build -t legal-aid-finder -t $REPO:$TRAVIS_BUILD_NUMBER -f Dockerfile .
  - npm test
  # - sudo docker-compose pull
  # - sudo docker-compose build --no-cache
after_success:
  - pip install --user awscli
  - export PATH=$PATH:$HOME/.local/bin
  - aws ecr create-repository --repository-name $REPO --region us-west-2
  - eval $(aws ecr get-login --region us-west-2)
  - docker tag $REPO:$TRAVIS_BUILD_NUMBER $AWS_ACCOUNT_NUMBER.dkr.ecr.us-west-2.amazonaws.com/$REPO:$TRAVIS_BUILD_NUMBER
  - docker push $AWS_ACCOUNT_NUMBER.dkr.ecr.us-west-2.amazonaws.com/$REPO:$TRAVIS_BUILD_NUMBER
  # - docker-compose push $AWS_ACCOUNT_NUMBER.dkr.ecr.us-west-2.amazonaws.com/$REPO:$TRAVIS_BUILD_NUMBER
  #- './node_modules/.bin/nyc report --reporter=text-lcov | ./node_modules/.bin/coveralls'
